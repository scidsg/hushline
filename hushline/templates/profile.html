{% extends "base.html" %}

{% block title %}
  {% if user.pgp_key %}
    {{ profile_header }}
  {% else %}
    Profile: {{ display_name_or_username }}
  {% endif %}
{% endblock %}

{% block content %}
  <h2 class="submit">
    {% if current_user_id == user.id %}
      {% if user.pgp_key %}
        {# Authenticated user viewing their own profile with PGP key #}
        ‚úçÔ∏è Note to Self
      {% else %}
        {# Authenticated user viewing their own profile without a PGP key #}
        ‚úçÔ∏è Note to Self (Add a PGP Key for secure notes)
      {% endif %}
    {% else %}
      {% if user.pgp_key %}
        {# Unauthenticated or other users who meet PGP requirements #}
        {{ profile_header }}
      {% else %}
        {# Unauthenticated or other users who don't meet PGP requirements #}
        {{ display_name_or_username }}
      {% endif %}
    {% endif %}
  </h2>

  {% if user.is_admin or username.is_verified %}
    <div class="badgeContainer">
      {% if user.is_admin %}
        <p class="badge">‚öôÔ∏è&nbsp;Admin</p>
      {% endif %}
      {% if username.is_verified %}
        <p class="badge">‚≠êÔ∏è&nbsp;Verified</p>
        <a
          class="meta"
          href="https://hushline.app/start-here.html"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Learn more about verified accounts."
          >Learn more</a
        >
      {% endif %}
    </div>
  {% endif %}

  {% if username.bio %}
    <p class="bio">{{ username.bio }}</p>
  {% endif %}

  {% if username.valid_fields | length > 0 %}
    <div class="extra-fields">
      {% for field in username.valid_fields %}
        <p class="extra-field">
          <span class="extra-field-label">{{ field.label }}</span>
          <span class="extra-field-value">
            {% if field.is_verified %}
              <span class="icon verifiedURL" title="Verified Address"></span>
            {% endif %}
            {% if field.value.startswith('https://') %}
              <a
                href="{{ field.value }}"
                target="_blank"
                rel="noopener noreferrer me"
                >{{ field.value }}</a
              >
            {% else %}
              {{ field.value }}
            {% endif %}
          </span>
        </p>
      {% endfor %}
    </div>
  {% endif %}

  {% if current_user_id == user.id %}
    <p class="instr">
      {% if not user.pgp_key %}
        <b>üëÅÔ∏è Only visible to you:</b> In order to protect your sources, you need
        to add a PGP key to your account before anyone can send you tips.
        Without a PGP key, your profile can still be listed in the Hush Line
        directory. Make sure to include a secure way to contact you, such as a
        Signal username, in your profile.
      {% else %}
        <b>üëÅÔ∏è Only visible to you:</b> This is your secure notepad and public tip line.
        When you're viewing your own profile, you'll see &quot;‚úçÔ∏è Note to Self&quot;, but when
        someone else is viewing this page, they'll see &quot;Submit a message to
        {{ display_name_or_username }}&quot;. You can use this form to send yourself
        secure notes or receive tips from others.
        <br>
        <br>Share the address in your browser's address bar on your social media profiles,
        your website, or email signature. Ensuring that someone submitting a message trusts
        this form belongs to you is important for establishing trust.
      {% endif %}
    </p>
  {% endif %}

  <form
    method="POST"
    action="{{ url_for('submit_message', username=username.username) }}"
    id="messageForm"
  >
    {% if not user.pgp_key %}
      {{ form.hidden_tag() }}
    {% endif %}
    
    {% for field_data in fields_to_display %}
      <div class="field-group">
        <div class="label">
          {{ form[field_data['name']].label(for=field_data['name']) }}
          {% if field_data['encrypted'] %}
            <span class="meta">üîí encrypted</span>
          {% endif %}
          {% if field_data['required'] %}
            <span class="meta">required</span>
          {% else %}
            <span class="meta">optional</span>
          {% endif %}
        </div>
        <div>
          {% if not user.pgp_key %}
            {{ form[field_data['name']](id=field_data['name'], disabled='disabled') }}
          {% else %}
            {% if field_data['encrypted'] %}
              {{ form[field_data['name']](id=field_data['name'], class='encrypted-field') }}
            {% else %}
              {{ form[field_data['name']](id=field_data['name']) }}
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <!-- Hidden field for public PGP key -->
    <input type="hidden" id="publicKey" value="{{ user.pgp_key }}" />
    <!-- Hidden field to indicate if the message was encrypted client-side -->
    <input
      type="hidden"
      name="client_side_encrypted"
      id="clientSideEncrypted"
      value="false"
    />

    {% if current_user_id == user.id %}
      {% if user.pgp_key %}
        <p class="helper meta">
          üîí Encrypted fields will be only readable by you.
        </p>
      {% else %}
        <p class="helper meta">
          ‚ö†Ô∏è Your messages will NOT be encrypted. If you expect messages to
          contain sensitive information, please
          <a
            href="https://github.com/scidsg/hushline/blob/main/docs/1-getting-started.md"
            target="_blank"
            rel="noopener noreferrer"
            >add a public PGP key</a
          >.
        </p>
      {% endif %}
    {% else %}
      {% if user.pgp_key %}
        <p class="helper meta">
          üîí Encrypted fields will be only readable by
          {{ display_name_or_username }}.
        </p>
      {% else %}
        <p class="helper meta">
          ‚ö†Ô∏è Your message will NOT be encrypted. If this message is sensitive,
          ask {{ display_name_or_username }} to add a public PGP key.
          <a
            href="https://github.com/scidsg/hushline/blob/main/docs/1-getting-started.md"
            target="_blank"
            rel="noopener noreferrer"
            >Here's how they can do it</a
          >.
        </p>
      {% endif %}
    {% endif %}

    {% if user.pgp_key %}
      <!-- Math CAPTCHA -->
      <div class="captcha">
        <p>ü§ñ Solve the math problem to submit your message.</p>
        <div class="captcha_container">
          <label for="captcha_answer">{{ math_problem }}</label>
          <input
            type="text"
            id="captcha_answer"
            name="captcha_answer"
            required=""
            autocomplete="off"
            aria-label="Solve {{ math_problem }} to submit your message"
          />
        </div>
      </div>
    {% endif %}

    <button
      type="submit"
      id="submitBtn"
      {% if not user.pgp_key %}disabled="disabled"{% endif %}
    >
      Send Message
    </button>

    {% if not user.pgp_key %}
      <div class="pgp-disabled-overlay">
        <p>
          üîí<br />
          Sending messages is disabled until {{ display_name_or_username }} adds
          a PGP key.
        </p>
      </div>
    {% endif %}
  </form>
{% endblock %}

{% block scripts %}
  {% if user.pgp_key %}
    <script src="{{ url_for('static', filename='vendor/openpgp-5.11.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/client-side-encryption.js') }}"></script>
    <script src="{{ url_for('static', filename='js/submit-message.js') }}"></script>
  {% endif %}
{% endblock %}
