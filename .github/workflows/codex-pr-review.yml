---
name: Codex PR Review

on:
  pull_request:
    types: [labeled]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: codex-pr-review-${{ github.event.pull_request.number || github.event.pull_request_review_comment.pull_request_url }}
  cancel-in-progress: false

jobs:
  reject-unauthorized-label:
    if: ${{ github.event_name == 'pull_request' && github.event.label.name == 'codex-review' && github.actor != 'glenn-sorrentino' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: remove codex-review label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            async function callWithRetry(fn, attempts = 3) {
              let lastErr;
              for (let i = 1; i <= attempts; i++) {
                try {
                  return await fn();
                } catch (err) {
                  lastErr = err;
                  if (i < attempts) {
                    await new Promise((r) => setTimeout(r, i * 1500));
                  }
                }
              }
              throw lastErr;
            }

            await callWithRetry(async () => {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: "codex-review"
                });
              } catch (err) {
                if (err.status !== 404) {
                  throw err;
                }
              }
            });

      - name: comment unauthorized attempt
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            async function callWithRetry(fn, attempts = 3) {
              let lastErr;
              for (let i = 1; i <= attempts; i++) {
                try {
                  return await fn();
                } catch (err) {
                  lastErr = err;
                  if (i < attempts) {
                    await new Promise((r) => setTimeout(r, i * 1500));
                  }
                }
              }
              throw lastErr;
            }

            await callWithRetry(async () => {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "The `codex-review` label can only be applied by `glenn-sorrentino`. The label was removed."
              });
            });

  review-pr:
    if: ${{ github.event_name == 'pull_request' && github.event.label.name == 'codex-review' && github.actor == 'glenn-sorrentino' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          persist-credentials: false

      - name: assess PR freshness
        id: freshness
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          MAX_PR_AGE_DAYS: "45"
        with:
          script: |
            const createdAt = new Date(context.payload.pull_request.created_at);
            const now = new Date();
            const ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
            const maxAge = Number(process.env.MAX_PR_AGE_DAYS || "45");
            const stale = ageDays > maxAge;
            core.setOutput("age_days", String(ageDays));
            core.setOutput("stale", stale ? "true" : "false");

      - name: comment stale PR gate
        if: ${{ steps.freshness.outputs.stale == 'true' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const ageDays = `${{ steps.freshness.outputs.age_days }}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Codex review skipped: this PR is ${ageDays} days old and may be stale. Re-apply the label if review is still needed.`
            });

      - name: remove codex-review label for stale PR
        if: ${{ steps.freshness.outputs.stale == 'true' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: "codex-review"
              });
            } catch (err) {
              if (err.status !== 404) {
                throw err;
              }
            }

      - name: prefetch base/head refs
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: capture PR diff and size
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        id: diff_meta
        run: |
          set -euo pipefail
          git diff --unified=0 \
            "${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}" \
            > /tmp/codex-pr.diff
          TOTAL_CHANGED=$(git diff --numstat "${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}" | awk '{add+=$1; del+=$2} END {print add+del+0}')
          echo "total_changed_lines=${TOTAL_CHANGED}" >> "$GITHUB_OUTPUT"
          if [ "${TOTAL_CHANGED}" -gt 2000 ]; then
            echo "too_large=true" >> "$GITHUB_OUTPUT"
          else
            echo "too_large=false" >> "$GITHUB_OUTPUT"
          fi

      - name: build review prompt
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const fs = require("fs");
            const diff = fs.readFileSync("/tmp/codex-pr.diff", "utf8");
            const pr = context.payload.pull_request;
            const tooLarge = `${{ steps.diff_meta.outputs.too_large }}` === "true";
            const sizeInstruction = tooLarge
              ? "Diff is large (>2000 changed lines). Do not emit inline suggestions; provide findings summary only."
              : "You may emit inline suggestions when safe and high-impact.";
            const prompt = [
              "You are reviewing a pull request in a security-critical repository.",
              "",
              "Follow AGENTS.md and any deeper AGENTS.md files.",
              "Focus on bugs, regressions, security/privacy issues, and missing tests.",
              "Keep feedback concrete and tied to changed lines in this PR.",
              sizeInstruction,
              "",
              "Return JSON matching the provided schema.",
              "",
              "Requirements for inline suggestions:",
              "- Suggest only edits on changed lines in the PR.",
              "- Each suggestion must replace exactly one line.",
              "- `path` must be a changed file path.",
              "- `line` must be the right-side (head) line number in that file.",
              "- `original` must match the current line content at `path:line`.",
              "- `replacement` must be a single line with no surrounding backticks.",
              "- Prefer high-impact suggestions that are safe to auto-apply.",
              "- If no safe one-line edit is appropriate, return zero suggestions.",
              "",
              "PR metadata:",
              `Repository: ${context.repo.owner}/${context.repo.repo}`,
              `PR number: ${pr.number}`,
              `Title: ${pr.title || ""}`,
              "Body:",
              pr.body || "",
              "",
              "Review only changes between:",
              `${pr.base.sha}...${pr.head.sha}`,
              "",
              "Unified diff (U0):",
              diff
            ].join("\n");

            fs.writeFileSync("/tmp/codex-pr-review-prompt.md", prompt, "utf8");

      - name: run codex review (attempt 1)
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        id: run_codex
        continue-on-error: true
        uses: openai/codex-action@086169432fb5e47eb8c114cf5781f1ca7f52e9ec
        env:
          GITHUB_TOKEN: ""
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          allow-users: glenn-sorrentino
          safety-strategy: drop-sudo
          sandbox: workspace-write
          prompt-file: /tmp/codex-pr-review-prompt.md
          output-file: /tmp/codex-pr-review.json
          output-schema: |
            {
              "type": "object",
              "required": ["summary", "findings", "suggestions"],
              "additionalProperties": false,
              "properties": {
                "summary": { "type": "string" },
                "findings": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "suggestions": {
                  "type": "array",
                  "maxItems": 20,
                  "items": {
                    "type": "object",
                    "required": ["path", "line", "original", "replacement", "rationale"],
                    "additionalProperties": false,
                    "properties": {
                      "path": { "type": "string" },
                      "line": { "type": "integer", "minimum": 1 },
                      "original": { "type": "string" },
                      "replacement": { "type": "string" },
                      "rationale": { "type": "string" }
                    }
                  }
                }
              }
            }

      - name: run codex review (retry)
        if: ${{ steps.freshness.outputs.stale == 'false' && steps.run_codex.outcome == 'failure' }}
        id: run_codex_retry
        uses: openai/codex-action@086169432fb5e47eb8c114cf5781f1ca7f52e9ec
        env:
          GITHUB_TOKEN: ""
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          allow-users: glenn-sorrentino
          safety-strategy: drop-sudo
          sandbox: workspace-write
          prompt-file: /tmp/codex-pr-review-prompt.md
          output-file: /tmp/codex-pr-review.json
          output-schema: |
            {
              "type": "object",
              "required": ["summary", "findings", "suggestions"],
              "additionalProperties": false,
              "properties": {
                "summary": { "type": "string" },
                "findings": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "suggestions": {
                  "type": "array",
                  "maxItems": 20,
                  "items": {
                    "type": "object",
                    "required": ["path", "line", "original", "replacement", "rationale"],
                    "additionalProperties": false,
                    "properties": {
                      "path": { "type": "string" },
                      "line": { "type": "integer", "minimum": 1 },
                      "original": { "type": "string" },
                      "replacement": { "type": "string" },
                      "rationale": { "type": "string" }
                    }
                  }
                }
              }
            }

      - name: upload review artifact
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: codex-pr-review-${{ github.event.pull_request.number }}
          path: /tmp/codex-pr-review.json
          if-no-files-found: ignore

      - name: post review summary
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          REVIEW_JSON_PATH: /tmp/codex-pr-review.json
          CHANGED_LINES: ${{ steps.diff_meta.outputs.total_changed_lines }}
        with:
          script: |
            const fs = require("fs");
            let parsed = { summary: "", findings: [], suggestions: [] };
            try {
              parsed = JSON.parse(fs.readFileSync(process.env.REVIEW_JSON_PATH, "utf8"));
            } catch (err) {
              parsed.summary = "Codex review could not be parsed as JSON.";
              parsed.findings = [`Parse error: ${err.message}`];
              parsed.suggestions = [];
            }

            const findings = (parsed.findings || []).slice(0, 20);
            const suggestions = parsed.suggestions || [];
            const findingText = findings.length
              ? findings.map((f) => `- ${f}`).join("\n")
              : "- No blocking findings identified.";
            const body = [
              "## Codex Review Summary",
              "",
              parsed.summary || "No summary provided.",
              "",
              `### Diff size: ${process.env.CHANGED_LINES || "0"} changed lines`,
              "",
              "### Findings",
              findingText,
              "",
              `### Inline suggestions queued: ${suggestions.length}`
            ].join("\n");

            async function callWithRetry(fn, attempts = 3) {
              let lastErr;
              for (let i = 1; i <= attempts; i++) {
                try {
                  return await fn();
                } catch (err) {
                  lastErr = err;
                  if (i < attempts) {
                    await new Promise((r) => setTimeout(r, i * 1500));
                  }
                }
              }
              throw lastErr;
            }

            await callWithRetry(async () => {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            });

      - name: comment suggestions skipped due to large diff
        if: ${{ steps.freshness.outputs.stale == 'false' && steps.diff_meta.outputs.too_large == 'true' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "Inline suggestions skipped because this PR exceeds the changed-line threshold (2000)."
            });

      - name: post inline one-click suggestions
        if: ${{ steps.freshness.outputs.stale == 'false' && steps.diff_meta.outputs.too_large == 'false' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          REVIEW_JSON_PATH: /tmp/codex-pr-review.json
        with:
          script: |
            const fs = require("fs");
            const crypto = require("crypto");
            let parsed = { suggestions: [] };
            try {
              parsed = JSON.parse(fs.readFileSync(process.env.REVIEW_JSON_PATH, "utf8"));
            } catch {
              parsed = { suggestions: [] };
            }

            const suggestions = (parsed.suggestions || []).slice(0, 20);
            const reviewComments = await github.paginate(github.rest.pulls.listReviewComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });

            const existingMarkers = new Set();
            for (const c of reviewComments) {
              const m = (c.body || "").match(/codex-suggestion-id:([a-f0-9]+)/i);
              if (m) {
                existingMarkers.add(m[1]);
              }
            }

            let posted = 0;
            let failed = 0;
            let deduped = 0;

            for (const s of suggestions) {
              const replacement = (s.replacement || "").replace(/\r/g, "");
              const rationale = (s.rationale || "Proposed improvement").trim();
              if (!s.path || !Number.isInteger(s.line) || !replacement) {
                failed++;
                continue;
              }

              const marker = crypto
                .createHash("sha256")
                .update(`${s.path}:${s.line}:${replacement}`)
                .digest("hex")
                .slice(0, 16);
              if (existingMarkers.has(marker)) {
                deduped++;
                continue;
              }

              const body = [
                `**Codex suggestion:** ${rationale}`,
                "",
                "```suggestion",
                replacement,
                "```",
                `<!-- codex-suggestion-id:${marker} -->`
              ].join("\n");

              try {
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  commit_id: context.payload.pull_request.head.sha,
                  path: s.path,
                  line: s.line,
                  side: "RIGHT",
                  body
                });
                posted++;
              } catch (err) {
                core.warning(`Failed suggestion for ${s.path}:${s.line} - ${err.message}`);
                failed++;
              }
            }

            const result = `Codex inline suggestion result: posted=${posted}, deduped=${deduped}, failed=${failed}.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: result
            });

      - name: remove codex-review label after processing
        if: ${{ steps.freshness.outputs.stale == 'false' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: "codex-review"
              });
            } catch (err) {
              if (err.status !== 404) {
                throw err;
              }
            }

  respond-to-suggestion-thread:
    if: ${{ github.event_name == 'pull_request_review_comment' && !endsWith(github.actor, '[bot]') }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: identify codex suggestion thread
        id: identify
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const comment = context.payload.comment;
            const pr = context.payload.pull_request;
            const trustedAssociations = new Set(["OWNER", "MEMBER", "COLLABORATOR"]);
            const isTrustedActor =
              comment?.user?.login === pr?.user?.login ||
              trustedAssociations.has(comment?.author_association || "");

            if (!isTrustedActor) {
              core.setOutput("should_respond", "false");
              return;
            }

            const inReplyTo = comment?.in_reply_to_id;
            if (!inReplyTo) {
              core.setOutput("should_respond", "false");
              return;
            }

            const parent = await github.rest.pulls.getReviewComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: inReplyTo
            });
            const parentData = parent.data || {};
            const parentAuthor = parentData.user?.login || "";
            const parentBody = parentData.body || "";
            const isCodexSuggestion =
              parentAuthor === "github-actions[bot]" &&
              parentBody.includes("**Codex suggestion:**");

            if (!isCodexSuggestion) {
              core.setOutput("should_respond", "false");
              return;
            }

            const prompt = [
              "You are replying to a contributor in a GitHub PR review thread.",
              "",
              "Follow AGENTS.md constraints. Keep response concise, technical, and helpful.",
              "Decide between: (a) explain why the contributor request is incorrect/risky, or (b) provide a revised one-line code suggestion.",
              "Choose revised suggestion only when it is safe and clearly better.",
              "Do not claim to have executed commands unless explicitly stated in context.",
              "Return strict JSON matching schema.",
              "",
              `Repository: ${context.repo.owner}/${context.repo.repo}`,
              `PR: #${context.payload.pull_request.number}`,
              `File: ${parentData.path || comment.path || ""}`,
              `Line: ${parentData.line || comment.line || ""}`,
              "",
              "Parent Codex suggestion comment:",
              parentBody,
              "",
              "Contributor reply:",
              comment.body || "",
              "",
              "JSON fields:",
              '- "action": one of ["explain","revise","no_response"]',
              '- "response": string (required for explain, optional otherwise)',
              '- "revision_rationale": string (required for revise)',
              '- "replacement": string one-line replacement code (required for revise, no backticks)'
            ].join("\n");

            require("fs").writeFileSync("/tmp/codex-followup-prompt.md", prompt, "utf8");
            core.setOutput("should_respond", "true");
            core.setOutput("reply_to_comment_id", String(comment.id));
            core.setOutput("parent_path", String(parentData.path || ""));
            core.setOutput("parent_line", String(parentData.line || ""));

      - name: run codex follow-up response (attempt 1)
        if: ${{ steps.identify.outputs.should_respond == 'true' }}
        id: followup_codex
        continue-on-error: true
        uses: openai/codex-action@086169432fb5e47eb8c114cf5781f1ca7f52e9ec
        env:
          GITHUB_TOKEN: ""
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          sandbox: read-only
          prompt-file: /tmp/codex-followup-prompt.md
          output-file: /tmp/codex-followup-response.json
          output-schema: |
            {
              "type": "object",
              "required": ["action", "response", "revision_rationale", "replacement"],
              "additionalProperties": false,
              "properties": {
                "action": {
                  "type": "string",
                  "enum": ["explain", "revise", "no_response"]
                },
                "response": { "type": "string" },
                "revision_rationale": { "type": "string" },
                "replacement": { "type": "string" }
              }
            }

      - name: run codex follow-up response (retry)
        if: ${{ steps.identify.outputs.should_respond == 'true' && steps.followup_codex.outcome == 'failure' }}
        uses: openai/codex-action@086169432fb5e47eb8c114cf5781f1ca7f52e9ec
        env:
          GITHUB_TOKEN: ""
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          sandbox: read-only
          prompt-file: /tmp/codex-followup-prompt.md
          output-file: /tmp/codex-followup-response.json
          output-schema: |
            {
              "type": "object",
              "required": ["action", "response", "revision_rationale", "replacement"],
              "additionalProperties": false,
              "properties": {
                "action": {
                  "type": "string",
                  "enum": ["explain", "revise", "no_response"]
                },
                "response": { "type": "string" },
                "revision_rationale": { "type": "string" },
                "replacement": { "type": "string" }
              }
            }

      - name: upload follow-up artifact
        if: ${{ steps.identify.outputs.should_respond == 'true' }}
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808
        with:
          name: codex-followup-${{ github.event.pull_request.number }}-${{ github.event.comment.id }}
          path: /tmp/codex-followup-response.json
          if-no-files-found: ignore

      - name: post codex follow-up
        if: ${{ steps.identify.outputs.should_respond == 'true' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          RESPONSE_JSON_PATH: /tmp/codex-followup-response.json
          REPLY_TO_COMMENT_ID: ${{ steps.identify.outputs.reply_to_comment_id }}
          PARENT_PATH: ${{ steps.identify.outputs.parent_path }}
          PARENT_LINE: ${{ steps.identify.outputs.parent_line }}
        with:
          script: |
            const fs = require("fs");
            let parsed = {
              action: "no_response",
              response: "",
              revision_rationale: "",
              replacement: ""
            };
            try {
              parsed = JSON.parse(fs.readFileSync(process.env.RESPONSE_JSON_PATH, "utf8"));
            } catch {
              parsed = {
                action: "explain",
                response: "I could not parse your follow-up request. Please restate the exact change and I will respond.",
                revision_rationale: "",
                replacement: ""
              };
            }

            const action = (parsed.action || "no_response").trim();
            if (action === "no_response") {
              return;
            }

            if (action === "revise") {
              const replacement = (parsed.replacement || "").replace(/\r/g, "").trim();
              const rationale = (parsed.revision_rationale || "Updated suggestion based on contributor feedback.").trim();
              const path = (process.env.PARENT_PATH || "").trim();
              const line = Number(process.env.PARENT_LINE || "0");

              if (!replacement || !path || !Number.isInteger(line) || line < 1) {
                await github.rest.pulls.createReplyForReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  comment_id: Number(process.env.REPLY_TO_COMMENT_ID),
                  body: "I agree with your direction, but I couldn't safely place an updated inline suggestion on the PR diff. Please point me to the exact line to revise."
                });
                return;
              }

              const body = [
                `**Codex updated suggestion:** ${rationale}`,
                "",
                "```suggestion",
                replacement,
                "```"
              ].join("\n");

              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_id: context.payload.pull_request.head.sha,
                path,
                line,
                side: "RIGHT",
                body
              });

              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: Number(process.env.REPLY_TO_COMMENT_ID),
                body: "Good call. I posted an updated one-click suggestion on that line."
              });
              return;
            }

            if (action === "explain") {
              const response = (parsed.response || "").trim();
              if (!response) {
                return;
              }
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: Number(process.env.REPLY_TO_COMMENT_ID),
                body: response
              });
            }
