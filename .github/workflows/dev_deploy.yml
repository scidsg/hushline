---
name: Deploy/Destroy Branch Dev Environment

on:
  pull_request:
    types: [labeled, closed]
    
env:
  TERRAFORM_CLOUD_TOKENS: app.terraform.io=${{ secrets.TERRAFORM_API_TOKEN }}
  ORGANIZATION: science-and-design
  PROJECT: Hush Line Dev
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  deploy:
    if: ${{ github.event.action == 'labeled' && github.event.label.name == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout terraform
        uses: actions/checkout@v4
        with:
          repository: 'scidsg/hushline-infra'
          ref: dev-deploy
          token: ${{ secrets.HUSHLINE_INFRA_TOKEN }}
 
      - name: Use branch workspace
        uses: dflook/terraform-new-workspace@v1.43.0
        with:
          path: terraform/dev
          workspace: dev-${{ github.head_ref }}
 
      - name: Update workspace attributes
        run: |
          curl -X PATCH https://app.terraform.io/api/v2/organizations/science-and-design/workspaces/dev-${{ github.head_ref }} \
               -H 'Content-Type: application/vnd.api+json' \
               -H 'Authorization: Bearer ${{ secrets.TERRAFORM_API_TOKEN }}' \
               -d '{
                     "data": {
                       "type": "workspaces",
                       "attributes": {
                         "working-directory": "terraform/dev"
                       },
                       "relationships": {
                         "project": {
                           "data": {
                             "id": "prj-iEruEQFmaNTCRAtA"
                           }
                         }
                       }
                     }
                   }'
  
      - name: Plan test infrastrucutre
        uses: dflook/terraform-plan@v1.43.0
        with:
          path: terraform/dev
          workspace: dev-${{ github.head_ref }}
          add_github_comment: true
          variables: |
            branch = "${{ github.head_ref }}"
            name = "hushline-${{ github.head_ref }}"
 
      - name: Apply test infrastrucutre
        uses: dflook/terraform-apply@v1.43.0
        with:
          path: terraform/dev
          workspace: dev-${{ github.head_ref }}
          variables: |
            branch = "${{ github.head_ref }}"
            name = "hushline-${{ github.head_ref }}"

      - name: terraform output
        uses: dflook/terraform-output@v1.43.0
        id: tf-outputs
        with:
          path: terraform/dev
          workspace: dev-${{ github.head_ref }}

      - name: comment app url
        uses: actions/github-script@v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ':rocket: App successfully deployed to ${{ steps.tf-outputs.outputs.app_live_url }}!'
            })
 
  destroy:
    if: ${{ (github.event.action == 'labeled' && github.event.label.name == 'destroy') || github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout terraform
        uses: actions/checkout@v4
        if: contains(github.event.pull_request.labels.*.name, 'deploy')
        with:
          repository: 'scidsg/hushline-infra'
          ref: dev-deploy
          token: ${{ secrets.HUSHLINE_INFRA_TOKEN }}
 
      - name: destroy worspace
        uses: dflook/terraform-destroy-workspace@v1.43.0
        if: contains(github.event.pull_request.labels.*.name, 'deploy')
        with:
          path: terraform/dev
          workspace: dev-${{ github.head_ref }}
          variables: |
            branch = "${{ github.head_ref }}"
            name = "hushline-${{ github.head_ref }}"
 
      - name: remove deploy label
        uses: actions-ecosystem/action-remove-labels@v1.3.0
        if: contains(github.event.pull_request.labels.*.name, 'deploy')
        with:
          github_token: ${{ github.token }}
          labels: |
            deploy
 
      - name: remove destroy label
        uses: actions-ecosystem/action-remove-labels@v1.3.0
        if: contains(github.event.pull_request.labels.*.name, 'destroy')
        with:
          github_token: ${{ github.token }}
          labels: |
            destroy
