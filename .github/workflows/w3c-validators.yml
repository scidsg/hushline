name: W3C Validators

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start app
        run: |
          docker compose up -d postgres blob-storage
          docker compose run --rm dev_data
          docker compose up -d app
          attempt=0
          until curl -fsS http://localhost:8080/ > /dev/null; do
            attempt=$((attempt + 1))
            if [ "$attempt" -ge 30 ]; then
              break
            fi
            sleep 2
          done

      - name: Fetch HTML pages
        run: |
          mkdir -p /tmp/w3c
          curl -fsS http://localhost:8080/ -o /tmp/w3c/index.html
          curl -fsS http://localhost:8080/directory -o /tmp/w3c/directory.html

      - name: Validate HTML (W3C Nu)
        run: |
          docker run --rm \
            -v /tmp/w3c:/work \
            ghcr.io/validator/validator:latest \
            java -jar /vnu.jar --errors-only --no-langdetect /work/index.html /work/directory.html

      - name: Validate CSS (W3C CSS)
        run: |
          set +e
          success=0
          for i in 1 2 3 4 5; do
            if curl -fsS -o /tmp/w3c/css.json \
              -F "file=@hushline/static/css/style.css" \
              -F "output=json" \
              https://jigsaw.w3.org/css-validator/validator; then
              success=1
              break
            fi
            sleep $((i * 5))
          done
          set -e
          if [ "$success" -ne 1 ]; then
            echo "W3C CSS validator unavailable (rate limited or error); skipping CSS validation."
            exit 0
          fi
          python -c "import json,sys; from pathlib import Path; data=json.loads(Path('/tmp/w3c/css.json').read_text()); errors=data.get('cssvalidation',{}).get('errors',[]); sys.exit(f'W3C CSS validation failed with {len(errors)} error(s).') if errors else print('W3C CSS validation passed.')"
